<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="renderer" content="webkit">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>一热/title>
	<!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<!-- 可选的 Bootstrap 主题文件（一般不用引入） -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
	<link href="css/extend.css" rel="stylesheet">
	<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]>
	<script src="http://cdn.bootcss.com/html5shiv/3.7.0/html5shiv.min.js"></script>
	<script src="http://cdn.bootcss.com/respond.js/1.3.0/respond.min.js"></script>
	<![endif]-->
</head>
<body>
<header class="navbar navbar-inverse navbar-fixed-top" role="banner">
	<div class="container">
		<div class="col-md-12 col-md-offset-0 col-lg-10 col-lg-offset-1">
			<div class="navbar-header">
				<button data-target=".navbar-collapse" data-toggle="collapse" type="button" class="navbar-toggle">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
			</div>
			<nav class="collapse navbar-collapse" role="navigation">
				<ul class="nav navbar-nav">
					<li class="spliter"><img src="img/top_spliter.png" alt=""></li>
					<li><a href="/">首页</a></li>
					<li class="spliter"><img src="img/top_spliter.png" alt=""></li>
				</ul>
				<ul class="nav navbar-nav navbar-right">
					<li class="spliter"><img src="img/top_spliter.png" alt=""></li>
					<li class="dropdown">
						<a data-toggle="dropdown" class="dropdown-toggle" href="javascript:void(0)">登陆/注册<b class="caret"></b></a>
						<ul class="dropdown-menu">
							<li><a href="http://bbs.gmfans.org/member.php?mod=logging&action=login">登陆</a></li>
							<li><a href="http://bbs.gmfans.org/forum-zj-1.html">注册</a></li>
						</ul>
					</li>
					<li class="spliter"><img src="img/top_spliter.png" alt=""></li>
				</ul>
			</nav>
		</div>
	</div>
</header>
		
<div class="container" role="main" id="content">
	<div class="col-md-12 col-md-offset-0 col-lg-8 col-lg-offset-2">
		<img class="gmfans-logo" src="img/logo-large.png" alt="gmfans">
		<div class="nav-icons">
			<ul>
				<li data-type="web"   class="web current"></li>
			</ul>
		</div>
		<div class="input-group">
			<span class="input-group-btn">
				<button type="button" class="btn dropdown-toggle search" data-toggle="dropdown">
					<span id="search-name">选择</span><span class="caret"></span>
				</button>
				<ul id="search-list" class="dropdown-menu">
				</ul>
			</span>
			<input id="search-word" type="text" maxlength="100" class="form-control search">
			<span class="input-group-btn">
				<button id="search-btn" type="button" class="btn search-btn"><span>&nbsp;</span></button>
			</span>
		</div>
		<div class="links-container">
			<div class="header">导航<a id="edit-btn" href="#">自定义网址</a href="#"><a id="finish-btn" style="display:none;" href="#">完成</a></div>
			<div class="links">
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="modalEdit" tabindex="-1" role="dialog" aria-labelledby="modalEdit-label" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title" id="modalEdit-label"></h4>
			</div>
			<div class="modal-body">
				<div class="input-group">
					<span class="input-group-addon">名称</span>
					<input type="text" maxlength="13" class="form-control" id="model-name">
				</div>
				<br/>
				<div class="input-group">
					<span class="input-group-addon">地址</span>
					<input type="text" maxlength="250" class="form-control" id="model-url">
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
				<button type="button" class="btn btn-primary" id="modal-button"></button>
			</div>
		</div>
	</div>
</div>

<script src="js/jquery.min.js"></script>
<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="js/jquery.nicescroll.js"></script>
<script src="js/jquery.scrollUp.min.js"></script>

<script>
	$(document).ready(function() {
		var nicesx = $("body").niceScroll({touchbehavior:false,cursorcolor:"#0000FF",cursoropacitymax:0.6,cursorwidth:8});
	});
	
	$(function () {
		$.scrollUp({
			'scrollName': 'scrollUp', // Element ID
			'topDistance': '300', // Distance from top before showing element (px)
			'topSpeed': 300, // Speed back to top (ms)
			'animation': 'fade', // Fade, slide, none
			'animationInSpeed': 200, // Animation in speed (ms)
			'animationOutSpeed': 200, // Animation out speed (ms)
			'scrollText': '', // Text for element
			'activeOverlay': false // Set CSS color to display scrollUp active point, e.g '#00FFFF'
		});
	});

	$(function(){
		var nav = $(".nav-icons ul"),
			list = $('ul#search-list'),
			search_engine = $('span#search-name'),
			search_word = $('input#search-word'),
			search_btn = $('button#search-btn'),
			edit_btn = $('#edit-btn'),
			finish_btn = $('#finish-btn'),
			links = $('.links-container .links');
		var fixed_links,
			user_links,
			search_engines_list,
			editing_id = -1;
		nav.click(function(e){
			e.preventDefault();
			if (e.target.tagName == 'LI' && ! $(e.target).hasClass('current')){
				nav.children('.current').removeClass('current');
				$(e.target).addClass('current');
				changeSearchType();
				search_word.focus();
			}
		});
		list.click(function(e){
			e.preventDefault();
			if (e.target.tagName == 'A'){
				var target = $(e.target),
					type = nav.children('.current').data('type');
				search_engine.text(target.text());
				search_engine.data("url",target.attr("href"));
				localStorage.setItem(type + ".sel", target.parent().index());
				search_word.focus();
			}
		});
		search_word.keypress(function(e){
			if (e.keyCode == 13){
				e.stopPropagation();
				e.preventDefault();
				search_btn.click();
			}
		});
		search_btn.click(function(e){
			var url = search_engine.data("url");
			url += encodeURIComponent(search_word.val());
			window.location.href = url;
		});
		edit_btn.click(function(e){
			e.preventDefault();
			e.stopPropagation();
			links.addClass('edit');
			finish_btn.css('display','');
			edit_btn.css('display','none');
		});
		finish_btn.click(function(e){
			e.preventDefault();
			e.stopPropagation();
			links.removeClass('edit');
			edit_btn.css('display','');
			finish_btn.css('display','none');
		});
		function showEditBox(title, button, name, url){
			$('#modalEdit-label').text(title);
			$('#modal-button').text(button);
			$('#model-name').val(name);
			$('#model-url').val(url);
			$('#modalEdit').modal({backdrop:'static'});
		};
		links.click(function(e){
			var tar = $(e.target);
			if (e.target.tagName == 'EM'){
				e.preventDefault();
				if (tar.hasClass("edit")){
					editing_id = tar.parent().data('id');
					showEditBox('修改','保存修改',user_links[editing_id].name,user_links[editing_id].url);  
				}
				else if (tar.hasClass("delete")){
					var id = tar.parent().data('id');
					if (confirm('确定要删除[' + user_links[id].name + "]吗?\n\n删除后无法撤销。")){
						user_links.splice(id, 1);
						saveUserUrls();
						showAllLinks();
					}
				}
			} else if (e.target.tagName == 'A' && tar.parents('.add-new').length > 0){
				e.preventDefault();
				editing_id= -1;
				showEditBox('添加','保存添加','','');
			}
		});
		$('#modal-button').click(function(e){
			var name_str = $('#model-name').val(),
				url_str = $('#model-url').val();
			if (name_str.length == 0 || url_str.length == 0)
				return;
			if (editing_id > -1 && user_links[editing_id].name == name_str && user_links[editing_id].url == url_str)
				return;
			if (url_str.toLowerCase().indexOf('http://') != 0)
				url_str = 'http://' + url_str;
			var item = {'name':name_str,'url':url_str};
			if (editing_id == -1){
				user_links.push(item);
			} else {
				user_links.splice(editing_id, 1, item);
			}
			saveUserUrls();
			showAllLinks();
			$('#modalEdit').modal('hide');
			editing_id = -1;
		});
		function parseJson(s) {
			if (/^(?:[[\]{},:+\-.\w$\s\u0100-\uffff]|"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*')+$/.test(s)){
				return eval('0,' + s);
			}
		};
		if ( ! window.localStorage){
			localStorage = function() {
				var obj = document.documentElement;
				obj.addBehavior("#default#userData");
				var d = new Date;
				d.setMonth(d.getMonth() + 12 * 10); /* 10年 */
				obj.expires = d.toUTCString();
				var sStoreName = 'userdata001';
				function F(f) {
					return function() {
						obj.load(sStoreName);
						f.apply(null, arguments);
						obj.save(sStoreName);
					};
				}
				return {
					setItem: F(function(key, value) {
						obj.setAttribute(key, value);
					}),
					getItem: function(key) {
						obj.load(sStoreName);
						return obj.getAttribute(key);
					},
					removeItem: F(function(key) {
						obj.removeAttribute(key);
					})
				};
			}();
		}
		var toJson = function() {
			function fe(s) {
				return function(c) {
					return s + c.charCodeAt(0).toString(16);
				};
			}
			var es = [
			/(?=["\\])/g, '\\',
			/\n/g, '\\n',
			/\r/g, '\\r',
			/\t/g, '\\t',
			/[\x00-\x0f]/g, fe('\\x0'),
			/[\x10-\x1f\x7f-\xff]/g, fe('\\x'),
			/[\u0100-\u0fff]/g, fe('\\u0'),
			/[\u1000-\u4dff\u9fa6-\uffff]/g, fe('\\u')
			];
			function encode_str(s) {
				for (var i = 0; i < es.length; i += 2)
					s = s.replace(es[i], es[i + 1]);
				return '"' + s + '"';
			}
			function encode(a) {
				var r, i;
				switch (typeof a) {
				case 'string':
					return encode_str(a);
				case 'number':
				case 'boolean':
					return a + '';
				case 'object':
					if (!a) return 'null';
					r = [];
					if (a instanceof Array) {
						if (a.length == 1 && a[0] == null)
							return '[null]';
						for (i = 0; i < a.length; i++)
							r[i] = a[i] == null ? '' : encode(a[i]);
						return '[' + r.join() + ']';
					}
					else {
						for (i in a)
							r[r.length] = encode_str(i) + ':' + encode(a[i]);
						return '{' + r.join() + '}';
					}
				case 'undefined':
					return 'null';
				default:
					throw Error(typeof a);
				}
			}
			return encode;
		}();
		function showFixed(){
			var tpl = '<div class="fixed"><span><a href="#URL#" title="#NAME#" target=_blank>#NAME#</a></span></div>';
			for (var i in fixed_links){
				var str = tpl.replace(/#URL#/g, fixed_links[i].url)
						.replace(/#NAME#/g, fixed_links[i].name);
				links.append(str);
			}
		};
		function loadUserUrls() {
			var s = localStorage.getItem('urls');
			if (s){try { return parseJson(s); } catch(e) { return [] }}
			else return [];
		};
		function saveUserUrls() {
			var s = toJson(user_links);
			localStorage.setItem('urls', s);
		};
		function showUserUrls(){
			var tpl = '<div><span><a href="#URL#" title="#NAME#">#NAME#</a></span><span class="toolkit" data-id="#ID#"><em class="edit" title="修改">&nbsp;</em><em class="delete" title="删除">&nbsp;</em></span></div>';
			for (i in user_links){
				var str = tpl.replace(/#ID#/g, i)
						.replace(/#URL#/g, user_links[i].url)
						.replace(/#NAME#/g, user_links[i].name);
				links.append(str);
			}
		};
		function showAddNew() {
			links.append('<div class="add-new"><span><a href="#" title="添加">&nbsp;</a></span></div>');
		};
		function showAllLinks(){
			links.children().remove();
			showFixed();
			user_links = loadUserUrls();
			showUserUrls();
			showAddNew();
		};
		$.get('jsondata/default.zh_cn.json',
				{},
				function(data, status, xhr){
					fixed_links = parseJson(data);
				},
				"html"
		).always(function(){
			showAllLinks();
		});
		function changeSearchType(){
			var type = nav.children('.current').data('type');
			list.children().remove();
			for (var i in search_engines_list[type]){
				var tpl = '<li><a href="#URL#">#NAME#</a></li>';
				tpl = tpl.replace(/#URL#/g, search_engines_list[type][i]["url"]);
				tpl = tpl.replace(/#NAME#/g, search_engines_list[type][i]["name"]);
				list.append(tpl);
			}
			var sel = localStorage.getItem(type + ".sel");
			if (sel === null || sel >= search_engines_list[type].length) sel = 0;
			search_engine.text(search_engines_list[type][sel]["name"]);
			search_engine.data("url",search_engines_list[type][sel]["url"]);
		};
		$.get('jsondata/search.zh_cn.json',
				{},
				function(data, status, xhr){
					search_engines_list = parseJson(data);
					changeSearchType();
				},
				"html"
		);
	});
</script>
<div id="footer" class="footer-m"><span>一热汗水敞起流</span></div>
</body>
</html>
